name: Deploy Node Prod (Blue-Green Routing)

on:
  push:
    branches: ["main"]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to OCIR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.OCI_REGISTRY }}
          username: ${{ secrets.OCI_USERNAME }}
          password: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          platforms: linux/arm64
          tags: ${{ secrets.OCI_REGISTRY }}/axslwmgnmqcx/findtheoctopus-node:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Blue-Green Switch via OCI Routing Policy (safe)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ubuntu
          key: ${{ secrets.OCI_KEY }}
          script: |
            set -e

            IMAGE="${{ secrets.OCI_REGISTRY }}/axslwmgnmqcx/findtheoctopus-node:latest"

            LB_OCID="${{ secrets.OCI_LB_OCID }}"
            ROUTING_POLICY_NAME="Octopus-Main-Policy"
            PROD_RULE_NAME="Prod_Node_Rule"
            BLUE_SET="NODE-BLUEset"
            GREEN_SET="NODE-GREENset"
            BLUE_PORT=3001
            GREEN_PORT=3002
            CONTAINER_PORT=3000

            if ! command -v jq >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y jq
            fi

            echo "ðŸ” Reading current routing policy..."
            CUR_JSON=$(oci lb routing-policy get --load-balancer-id "$LB_OCID" --routing-policy-name "$ROUTING_POLICY_NAME")
            CURRENT_SET=$(echo "$CUR_JSON" | jq -r --arg RN "$PROD_RULE_NAME" '.data.rules[] | select(.name==$RN) | .actions[0].backendSetName')

            if [ -z "$CURRENT_SET" ] || [ "$CURRENT_SET" = "null" ]; then
              echo "âŒ Cannot find rule name '$PROD_RULE_NAME' in routing policy '$ROUTING_POLICY_NAME'."
              exit 1
            fi

            echo "âœ… Current PROD backend set: $CURRENT_SET"

            if [ "$CURRENT_SET" = "$BLUE_SET" ]; then
              TARGET_SET="$GREEN_SET"
              TARGET_COLOR="green"
              TARGET_PORT=$GREEN_PORT
              OLD_COLOR="blue"
              OLD_PORT=$BLUE_PORT
            else
              TARGET_SET="$BLUE_SET"
              TARGET_COLOR="blue"
              TARGET_PORT=$BLUE_PORT
              OLD_COLOR="green"
              OLD_PORT=$GREEN_PORT
            fi

            echo "ðŸš€ Switching to $TARGET_COLOR: set=$TARGET_SET, port=$TARGET_PORT"

            echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login "${{ secrets.OCI_REGISTRY }}" -u "${{ secrets.OCI_USERNAME }}" --password-stdin
            docker pull "$IMAGE"

            docker rm -f "octopus-node-$TARGET_COLOR" >/dev/null 2>&1 || true

            docker run -d --name "octopus-node-$TARGET_COLOR" \
              -p "$TARGET_PORT:$CONTAINER_PORT" \
              --restart unless-stopped \
              -e BACKEND_URL="https://api.find-octopus.com/api" \
              -e PORT="$CONTAINER_PORT" \
              "$IMAGE"

            echo "â³ Waiting for health check..."
            OK=0
            for i in {1..20}; do
              if curl -sf "http://127.0.0.1:$TARGET_PORT/health" >/dev/null 2>&1; then
                OK=1; break
              fi
              if curl -sf "http://127.0.0.1:$TARGET_PORT/" >/dev/null 2>&1; then
                OK=1; break
              fi
              sleep 3
            done

            if [ "$OK" -ne 1 ]; then
              echo "âŒ Health check failed on http://127.0.0.1:$TARGET_PORT"
              docker logs --tail 200 "octopus-node-$TARGET_COLOR" || true
              exit 1
            fi
            echo "âœ… Node container is healthy on port $TARGET_PORT"

            echo "ðŸ” Updating routing policy rule action backendSetName -> $TARGET_SET"

            UPDATED_RULES=$(echo "$CUR_JSON" | jq --arg RN "$PROD_RULE_NAME" --arg BS "$TARGET_SET" '
              .data.rules
              | map(
                  if .name == $RN
                  then (.actions[0].backendSetName = $BS)
                  else .
                  end
                )
            ')

            echo "$UPDATED_RULES" > /tmp/rules.json

            oci lb routing-policy update \
              --load-balancer-id "$LB_OCID" \
              --routing-policy-name "$ROUTING_POLICY_NAME" \
              --rules file:///tmp/rules.json

            echo "âœ… Routing policy switched to $TARGET_SET"

            echo "ðŸ§¹ Cleanup old container after stabilization..."
            sleep 60
            docker rm -f "octopus-node-$OLD_COLOR" >/dev/null 2>&1 || true

            echo "ðŸŽ‰ Active: $TARGET_COLOR ($TARGET_PORT) / backendSet: $TARGET_SET"
