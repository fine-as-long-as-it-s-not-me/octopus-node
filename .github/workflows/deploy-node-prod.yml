name: Deploy Node Prod (Blue-Green Routing)

on:
  push:
    branches: ["main"]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to OCIR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.OCI_REGISTRY }}
          username: ${{ secrets.OCI_USERNAME }}
          password: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          platforms: linux/arm64
          tags: ${{ secrets.OCI_REGISTRY }}/axslwmgnmqcx/findtheoctopus-node:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Blue-Green Switch via OCI Routing Policy (debug + wait work request)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ubuntu
          key: ${{ secrets.OCI_KEY }}
          script: |
            set -e
            set -x

            export PATH="/home/ubuntu/bin:$PATH"

            IMAGE="${{ secrets.OCI_REGISTRY }}/axslwmgnmqcx/findtheoctopus-node:latest"

            LB_OCID="${{ secrets.OCI_LB_OCID }}"
            ROUTING_POLICY_NAME="ProdPolicy"
            PROD_RULE_NAME="Prod_Node_Rule"
            BLUE_SET="NODE-BLUEset"
            GREEN_SET="NODE-GREENset"
            BLUE_PORT=3001
            GREEN_PORT=3002
            CONTAINER_PORT=3000

            OCI_REGION="ap-osaka-1"
            OCI_AUTH="instance_principal"

            echo "STEP 0: ensure jq"
            if ! command -v jq >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y jq
            fi

            echo "STEP 1: read routing policy"
            CUR_JSON=$(oci lb routing-policy get \
              --load-balancer-id "$LB_OCID" \
              --routing-policy-name "$ROUTING_POLICY_NAME" \
              --auth "$OCI_AUTH" \
              --region "$OCI_REGION")

            echo "STEP 2: determine current backend set"
            CURRENT_SET=$(echo "$CUR_JSON" | jq -r --arg RN "$PROD_RULE_NAME" '
              .data.rules[]
              | select(.name==$RN)
              | .actions[0]["backend-set-name"]
            ')

            if [ -z "$CURRENT_SET" ] || [ "$CURRENT_SET" = "null" ]; then
              echo "ERROR: cannot read current backend set for rule '$PROD_RULE_NAME'"
              echo "$CUR_JSON" | jq -r '.data.rules[]?.name' || true
              exit 1
            fi

            echo "CURRENT_SET=$CURRENT_SET"

            echo "STEP 3: choose target"
            if [ "$CURRENT_SET" = "$BLUE_SET" ]; then
              TARGET_SET="$GREEN_SET"
              TARGET_COLOR="green"
              TARGET_PORT=$GREEN_PORT
              OLD_COLOR="blue"
            else
              TARGET_SET="$BLUE_SET"
              TARGET_COLOR="blue"
              TARGET_PORT=$BLUE_PORT
              OLD_COLOR="green"
            fi

            echo "TARGET_SET=$TARGET_SET TARGET_COLOR=$TARGET_COLOR TARGET_PORT=$TARGET_PORT OLD_COLOR=$OLD_COLOR"

            echo "STEP 4: docker login/pull"
            echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login "${{ secrets.OCI_REGISTRY }}" -u "${{ secrets.OCI_USERNAME }}" --password-stdin
            docker pull "$IMAGE"

            echo "STEP 5: run target container"
            docker rm -f "octopus-node-$TARGET_COLOR" || true

            docker run -d --name "octopus-node-$TARGET_COLOR" \
              -p "$TARGET_PORT:$CONTAINER_PORT" \
              --restart unless-stopped \
              -e BACKEND_URL="https://api.find-octopus.com/api" \
              -e PORT="$CONTAINER_PORT" \
              "$IMAGE"

            echo "STEP 6: health check"
            OK=0
            for i in {1..20}; do
              if curl -sf "http://127.0.0.1:$TARGET_PORT/health" >/dev/null 2>&1; then
                OK=1; break
              fi
              if curl -sf "http://127.0.0.1:$TARGET_PORT/" >/dev/null 2>&1; then
                OK=1; break
              fi
              sleep 3
            done

            if [ "$OK" -ne 1 ]; then
              echo "ERROR: health check failed on port $TARGET_PORT"
              docker ps -a
              docker logs --tail 200 "octopus-node-$TARGET_COLOR" || true
              exit 1
            fi

            echo "STEP 7: write rules.json safely (NO echo raw json)"
            jq -c --arg RN "$PROD_RULE_NAME" --arg BS "$TARGET_SET" '
              .data.rules
              | map(if .name == $RN then (.actions[0]["backend-set-name"] = $BS) else . end)
            ' <<<"$CUR_JSON" > /tmp/rules.json

            cat /tmp/rules.json | jq '.'

            echo "STEP 8: routing-policy update (force) + capture work request"
            WR_ID=$(oci lb routing-policy update \
              --load-balancer-id "$LB_OCID" \
              --routing-policy-name "$ROUTING_POLICY_NAME" \
              --rules file:///tmp/rules.json \
              --force \
              --auth "$OCI_AUTH" \
              --region "$OCI_REGION" \
              --query "opc-work-request-id" \
              --raw-output)

            echo "WORK_REQUEST_ID=$WR_ID"

            echo "STEP 8-1: wait work request SUCCEEDED"
            for i in {1..120}; do
              STATUS=$(oci lb work-request get \
                --work-request-id "$WR_ID" \
                --auth "$OCI_AUTH" \
                --region "$OCI_REGION" \
                --query "data.lifecycle-state" \
                --raw-output)

              echo "WR_STATUS=$STATUS"
              if [ "$STATUS" = "SUCCEEDED" ]; then
                break
              fi
              if [ "$STATUS" = "FAILED" ]; then
                echo "ERROR: work request failed"
                oci lb work-request get --work-request-id "$WR_ID" --auth "$OCI_AUTH" --region "$OCI_REGION" || true
                exit 1
              fi
              sleep 5
            done

            echo "STEP 9: verify routing policy switched"
            NEW_JSON=$(oci lb routing-policy get \
              --load-balancer-id "$LB_OCID" \
              --routing-policy-name "$ROUTING_POLICY_NAME" \
              --auth "$OCI_AUTH" \
              --region "$OCI_REGION")

            NEW_SET=$(echo "$NEW_JSON" | jq -r --arg RN "$PROD_RULE_NAME" '
              .data.rules[]
              | select(.name==$RN)
              | .actions[0]["backend-set-name"]
            ')

            echo "NEW_SET=$NEW_SET (expected $TARGET_SET)"
            if [ "$NEW_SET" != "$TARGET_SET" ]; then
              echo "ERROR: routing policy not updated to target set"
              exit 1
            fi

            echo "STEP 10: cleanup old container after stabilization"
            sleep 60
            docker rm -f "octopus-node-$OLD_COLOR" || true

            echo "DONE: Active=$TARGET_COLOR port=$TARGET_PORT backendSet=$TARGET_SET"
