name: Deploy Node Prod

on:
  push:
    branches: ["main"]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to OCIR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.OCI_REGISTRY }}
          username: ${{ secrets.OCI_USERNAME }}
          password: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          platforms: linux/arm64
          tags: ${{ secrets.OCI_REGISTRY }}/axslwmgnmqcx/findtheoctopus-node:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Blue-Green Switch via OCI Routing Policy (safe)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ubuntu
          key: ${{ secrets.OCI_KEY }}
          script: |
            set -e

            export PATH="/home/ubuntu/bin:$PATH"

            IMAGE="${{ secrets.OCI_REGISTRY }}/axslwmgnmqcx/findtheoctopus-node:latest"

            LB_OCID="${{ secrets.OCI_LB_OCID }}"
            ROUTING_POLICY_NAME="ProdPolicy"
            PROD_RULE_NAME="Prod_Node_Rule"
            BLUE_SET="NODE-BLUEset"
            GREEN_SET="NODE-GREENset"
            BLUE_PORT=3001
            GREEN_PORT=3002
            CONTAINER_PORT=3000

            OCI_REGION="ap-osaka-1"
            OCI_AUTH="instance_principal"

            if ! command -v jq >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y jq
            fi

            CUR_JSON=$(oci lb routing-policy get \
              --load-balancer-id "$LB_OCID" \
              --routing-policy-name "$ROUTING_POLICY_NAME" \
              --auth "$OCI_AUTH" \
              --region "$OCI_REGION")

            CURRENT_SET=$(echo "$CUR_JSON" | jq -r --arg RN "$PROD_RULE_NAME" '.data.rules[] | select(.name==$RN) | .actions[0].backendSetName')

            if [ -z "$CURRENT_SET" ] || [ "$CURRENT_SET" = "null" ]; then
              exit 1
            fi

            if [ "$CURRENT_SET" = "$BLUE_SET" ]; then
              TARGET_SET="$GREEN_SET"
              TARGET_COLOR="green"
              TARGET_PORT=$GREEN_PORT
              OLD_COLOR="blue"
            else
              TARGET_SET="$BLUE_SET"
              TARGET_COLOR="blue"
              TARGET_PORT=$BLUE_PORT
              OLD_COLOR="green"
            fi

            echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login "${{ secrets.OCI_REGISTRY }}" -u "${{ secrets.OCI_USERNAME }}" --password-stdin
            docker pull "$IMAGE"

            docker rm -f "octopus-node-$TARGET_COLOR" >/dev/null 2>&1 || true

            docker run -d --name "octopus-node-$TARGET_COLOR" \
              -p "$TARGET_PORT:$CONTAINER_PORT" \
              --restart unless-stopped \
              -e BACKEND_URL="https://api.find-octopus.com/api" \
              -e PORT="$CONTAINER_PORT" \
              "$IMAGE"

            OK=0
            for i in {1..20}; do
              if curl -sf "http://127.0.0.1:$TARGET_PORT/health" >/dev/null 2>&1; then
                OK=1; break
              fi
              if curl -sf "http://127.0.0.1:$TARGET_PORT/" >/dev/null 2>&1; then
                OK=1; break
              fi
              sleep 3
            done

            if [ "$OK" -ne 1 ]; then
              docker logs --tail 200 "octopus-node-$TARGET_COLOR" >/dev/null 2>&1 || true
              exit 1
            fi

            UPDATED_RULES=$(echo "$CUR_JSON" | jq --arg RN "$PROD_RULE_NAME" --arg BS "$TARGET_SET" '
              .data.rules
              | map(if .name == $RN then (.actions[0].backendSetName = $BS) else . end)
            ')

            echo "$UPDATED_RULES" | jq -e 'type=="array"' >/dev/null 2>&1 || exit 1
            echo "$UPDATED_RULES" > /tmp/rules.json

            oci lb routing-policy update \
              --load-balancer-id "$LB_OCID" \
              --routing-policy-name "$ROUTING_POLICY_NAME" \
              --rules file:///tmp/rules.json \
              --force \
              --auth "$OCI_AUTH" \
              --region "$OCI_REGION" \
              --wait-for-state SUCCEEDED \
              --max-wait-seconds 900 \
              --wait-interval-seconds 10

            sleep 10
            docker rm -f "octopus-node-$OLD_COLOR" >/dev/null 2>&1 || true
